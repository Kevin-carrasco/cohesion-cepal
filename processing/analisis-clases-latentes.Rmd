---
title: "analisis clases latentes"
author: "Equipo CEPAL-COES"
date: "30-09-2021"
output:
  html_document:
    number_sections: true
    toc: true
    toc_float: true
---

# recodificacion de indicadores

Este documento genera, en primer lugar, los indicadores necesarios para realizar el análisis y posteriormente se realiza el análisis de clases latentes. 

Los indicadores son recodificados de la siguiente forma:

1) En cada ola de la encuesta ELSOC se estiman las medias de los indicadores (que fueron seleccionados según los criterios del capítulo I) para cada subdimension. El resultado es tener el promedio simple de cada subdimensión en todas las olas que estos indicadores están presentes

2) Se estima la media general de cada subdimensión según las medias estimadas en el paso anterior. El resultado es tener 9 promedios simples, uno por cada subdimensión.

3) Para categorizar las variables en dos categorías de respuestas y realizar el análisis de clases latentes, se establece como criterio de corte la mediana de cada variable. Los valores menores o iguales a la mediana se consideran como "1" y los valores mayores a la mediana se consideran como "2".


```{r}
pacman::p_load(dplyr, 
               summarytools, 
               poLCA,
               sjPlot,
               sjmisc)
```

```{r}
load("input/data/data.RData")
```

## Relaciones sociales de igualdad
### Confianza interpersonal (w01, w02, w03, w04 & w05)
```{r}
### estimar promedio simple de cada subdimensión en todas las olas que estos indicadores están presentes
data <- data %>%
  rowwise() %>%
  mutate(conf_interpersonal_w01 =
           mean(c(c02_rec_w01, c03_rec_w01), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(conf_interpersonal_w02 =
           mean(c(c02_rec_w02, c03_rec_w02), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(conf_interpersonal_w03 =
           mean(c(c02_rec_w03, c03_rec_w03), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(conf_interpersonal_w04 =
           mean(c(c02_rec_w04, c03_rec_w04), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(conf_interpersonal_w05 =
           mean(c(c02_rec_w05, c03_rec_w05), na.rm = T))

data %>% dplyr::select(conf_interpersonal_w01, conf_interpersonal_w02, conf_interpersonal_w03, conf_interpersonal_w04, conf_interpersonal_w05) %>%  dfSummary(, graph.col = FALSE)
```

```{r}
### Estimar el promedio general de todas las olas
data <- data %>% 
  rowwise() %>%
  mutate(conf_interpersonal = mean(c(conf_interpersonal_w01, 
                        conf_interpersonal_w02, 
                        conf_interpersonal_w03, 
                        conf_interpersonal_w04, 
                        conf_interpersonal_w05), na.rm=T))

data %>% dplyr::select(conf_interpersonal) %>% dfSummary(, graph.col = FALSE)
```

```{r}
# La mediana es 1.2
data <- data %>% mutate(conf_interpersonal = ifelse(conf_interpersonal<=1.2, 1, 2))

data %>% dplyr::select(conf_interpersonal) %>% dfSummary(, graph.col = FALSE)
```

### Reconocimiento y respeto de la diversidad (w01, w02, w03, w04 & w05)

```{r}
### estimar promedio simple de cada subdimensión en todas las olas que estos indicadores están presentes
data <- data %>%
  rowwise() %>%
  mutate(diversidad_w01 =
           mean(c(c06_04_w01, c06_05_w01, c06_06_w01), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(diversidad_w03 =
           mean(c(c06_04_w03, c06_05_w03, c06_06_w03), na.rm = T))

data %>% dplyr::select(diversidad_w01, diversidad_w03) %>%  summarytools::dfSummary(, graph.col = FALSE)
```

```{r}
### Estimar el promedio general de todas las olas
data <- data %>% 
  rowwise() %>%
  mutate(diversidad = mean(c(diversidad_w01, diversidad_w03), na.rm=T))


# Check
data %>% dplyr::select(diversidad) %>%  dfSummary(, graph.col = FALSE)
```

```{r}
# La mediana es 2.8
data <- data %>% mutate(diversidad = ifelse(diversidad<=2.8, 1, 2))

data %>% dplyr::select(diversidad) %>% dfSummary(, graph.col = FALSE)
```

### Lazos
```{r}
### Pasar la variable a numérica
data$lazos_w01 = as.numeric(data$vol.red_w01)
data$lazos_w03 = as.numeric(data$vol.red_w03)


data %>% dplyr::select(lazos_w01, lazos_w03)  %>%  dfSummary(, graph.col = FALSE)
```

```{r}
### Estimar el promedio general de todas las olas
data <- data %>% 
  rowwise() %>%
  mutate(lazos = mean(c(lazos_w01, lazos_w03), na.rm=T))

# Check
data %>% dplyr::select(lazos) %>%  dfSummary(, graph.col = FALSE)
```

```{r}
# La mediana es 4
data <- data %>% mutate(lazos = ifelse(lazos<=4, 1, 2))

data %>% dplyr::select(lazos) %>% dfSummary(, graph.col = FALSE)
```

## Sentido de pertenencia
### Identificación con el país
```{r}
### estimar promedio simple de cada subdimensión en todas las olas que estos indicadores están presentes
data <- data %>%
  rowwise() %>%
  mutate(identificacion_w01 =
           mean(c(c32_01_w01, c32_02_w01), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(identificacion_w02 =
           mean(c(c32_01_w02, c32_02_w02), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(identificacion_w03 =
           mean(c(c32_01_w03, c32_02_w03), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(identificacion_w04 =
           mean(c(c32_01_w04, c32_02_w04), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(identificacion_w05 =
           mean(c(c32_01_w05, c32_02_w05), na.rm = T))

data %>% dplyr::select(identificacion_w01, identificacion_w02, identificacion_w03, identificacion_w04, identificacion_w05) %>%  dfSummary(, graph.col = FALSE)
```

```{r}
### Estimar el promedio general de todas las olas
data <- data %>% 
  rowwise() %>%
  mutate(identificacion = mean(c(identificacion_w01, 
                                 identificacion_w02, 
                                 identificacion_w03, 
                                 identificacion_w04, 
                                 identificacion_w05), na.rm=T))

data %>% dplyr::select(identificacion)  %>%  dfSummary(, graph.col = FALSE)
```

```{r}
# La mediana es 4.4
data <- data %>% mutate(identificacion = ifelse(identificacion<=4.4, 1, 2))

data %>% dplyr::select(identificacion) %>% dfSummary(, graph.col = FALSE)
```


### Percepción de justicia
```{r}
### estimar promedio simple de cada subdimensión en todas las olas que estos indicadores están presentes
data <- data %>%
  rowwise() %>%
  mutate(justicia_w01 =
           mean(c(c18_09_w01, c18_10_w01), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(justicia_w02 =
           mean(c(c18_09_w02, c18_10_w02), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(justicia_w03 =
           mean(c(c18_09_w03, c18_10_w03), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(justicia_w04 =
           mean(c(c18_09_w04, c18_10_w04), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(justicia_w05 =
           mean(c(c18_09_w05, c18_10_w05), na.rm = T))

data %>% dplyr::select(justicia_w01, justicia_w02, justicia_w03, justicia_w04, justicia_w05) %>%  dfSummary(, graph.col = FALSE)
```

```{r}
### Estimar el promedio general de todas las olas
data <- data %>% 
  rowwise() %>%
  mutate(justicia = mean(c(justicia_w01, 
                           justicia_w02, 
                           justicia_w03, 
                           justicia_w04, 
                           justicia_w05), na.rm=T))

data %>% dplyr::select(justicia)  %>%  dfSummary(, graph.col = FALSE)
```

```{r}
# La mediana es 2.6
data <- data %>% mutate(justicia = ifelse(justicia<=2.6, 1, 2))

data %>% dplyr::select(justicia) %>% dfSummary(, graph.col = FALSE)
```

### Confianza institucional
```{r}
### estimar promedio simple de cada subdimensión en todas las olas que estos indicadores están presentes
data <- data %>%
  rowwise() %>%
  mutate(conf_institucional_w01 =
           mean(c(c05_01_w01, c05_08_w01, c05_02_w01), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(conf_institucional_w02 =
           mean(c(c05_01_w02, c05_08_w02, c05_02_w02), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(conf_institucional_w03 =
           mean(c(c05_01_w03, c05_08_w03, c05_02_w03), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(conf_institucional_w04 =
           mean(c(c05_01_w04, c05_08_w04, c05_02_w04), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(conf_institucional_w05 =
           mean(c(c05_01_w05, c05_08_w05, c05_02_w05), na.rm = T))

data %>% dplyr::select(conf_institucional_w01, conf_institucional_w02, conf_institucional_w03, conf_institucional_w04, conf_institucional_w05)  %>%  dfSummary(, graph.col = FALSE)
```

```{r}
### Estimar el promedio general de todas las olas
data <- data %>% 
  rowwise() %>%
  mutate(conf_institucional = mean(c(conf_institucional_w01, 
                                     conf_institucional_w02, 
                                     conf_institucional_w03,
                                     conf_institucional_w04,
                                     conf_institucional_w05), na.rm=T))

data %>% dplyr::select(conf_institucional)  %>% sjlabelled::as_label(.)  %>%  dfSummary(, graph.col = FALSE)
```

```{r}
# La mediana es 1.7
data <- data %>% mutate(conf_institucional = ifelse(conf_institucional<=1.7, 1, 2))

data %>% dplyr::select(conf_institucional) %>% dfSummary(, graph.col = FALSE)
```


## Orientación hacia el bien comun
### solidaridad
```{r}
### estimar promedio simple de cada subdimensión en todas las olas que estos indicadores están presentes
data <- data %>%
  rowwise() %>%
  mutate(solidaridad_w01 =
           mean(c(c07_05_w01, c07_06_w01, c07_07_w01, c07_08_w01), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(solidaridad_w02 =
           mean(c(c07_05_w02, c07_06_w02, c07_07_w02, c07_08_w02), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(solidaridad_w03 =
           mean(c(c07_05_w03, c07_06_w03, c07_07_w03, c07_08_w03), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(solidaridad_w04 =
           mean(c(c07_05_w04, c07_06_w04, c07_07_w04, c07_08_w04), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(solidaridad_w05 =
           mean(c(c07_05_w05, c07_06_w05, c07_07_w05, c07_08_w05), na.rm = T))

data %>% dplyr::select(solidaridad_w01, solidaridad_w02, solidaridad_w03, solidaridad_w04, solidaridad_w05) %>%  dfSummary(, graph.col = FALSE)
```

```{r}
### Estimar el promedio general de todas las olas
data <- data %>% 
  rowwise() %>%
  mutate(solidaridad = mean(c(solidaridad_w01, 
                              solidaridad_w02, 
                              solidaridad_w03, 
                              solidaridad_w04, 
                              solidaridad_w05), na.rm=T))

data %>% dplyr::select(solidaridad)  %>%  dfSummary(, graph.col = FALSE)
```

```{r}
# La mediana es 2.1
data <- data %>% mutate(solidaridad = ifelse(solidaridad<=2.1, 1, 2))

data %>% dplyr::select(solidaridad) %>% dfSummary(, graph.col = FALSE)
```

## Participación cívica
```{r}
### estimar promedio simple de cada subdimensión en todas las olas que estos indicadores están presentes
data <- data %>%
  rowwise() %>%
  mutate(participacion_w01 =
           mean(c(c08_01_w01, c08_02_w01, c08_03_w01, c08_04_w01), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(participacion_w02 =
           mean(c(c08_01_w02, c08_02_w02, c08_03_w02, c08_04_w02), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(participacion_w03 =
           mean(c(c08_01_w03, c08_02_w03, c08_03_w03, c08_04_w03), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(participacion_w04 =
           mean(c(c08_01_w04, c08_02_w04, c08_03_w04, c08_04_w04), na.rm = T))

data %>% dplyr::select(participacion_w01, participacion_w02, participacion_w03, participacion_w04) %>%  dfSummary(, graph.col = FALSE)
```

```{r}
### Estimar el promedio general de todas las olas
data <- data %>% 
  rowwise() %>%
  mutate(participacion = mean(c(participacion_w01, 
                                participacion_w02, 
                                participacion_w03,
                                participacion_w04), na.rm=T))

data %>% dplyr::select(participacion) %>%  dfSummary(, graph.col = FALSE)
```

```{r}
# La mediana es 1.2
data <- data %>% mutate(participacion = ifelse(participacion<=1.2, 1, 2))

data %>% dplyr::select(participacion) %>% dfSummary(, graph.col = FALSE)
```


## Cohesión territorial
```{r}
### estimar promedio simple de cada subdimensión en todas las olas que estos indicadores están presentes
data <- data %>%
  rowwise() %>%
  mutate(cohesion_territorial_w01 =
           mean(c(t02_01_w01, t02_02_w01, t02_03_w01, t02_04_w01), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(cohesion_territorial_w02 =
           mean(c(t02_01_w02, t02_02_w02, t02_03_w02, t02_04_w02), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(cohesion_territorial_w03 =
           mean(c(t02_01_w03, t02_02_w03, t02_03_w03, t02_04_w03), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(cohesion_territorial_w04 =
           mean(c(t02_01_w04, t02_02_w04, t02_03_w04, t02_04_w04), na.rm = T))

data %>% dplyr::select(cohesion_territorial_w01, cohesion_territorial_w02, cohesion_territorial_w03, cohesion_territorial_w04) %>%  dfSummary(, graph.col = FALSE)
```


```{r}
### Estimar el promedio general de todas las olas
data <- data %>% 
  rowwise() %>%
  mutate(cohesion_territorial = mean(c(cohesion_territorial_w01, 
                                       cohesion_territorial_w02, 
                                       cohesion_territorial_w03, 
                                       cohesion_territorial_w04), na.rm=T))

data %>% dplyr::select(cohesion_territorial)  %>% sjlabelled::as_label(.)  %>%  dfSummary(, graph.col = FALSE)
```

```{r}
# La mediana es 3.9
data <- data %>% mutate(cohesion_territorial = ifelse(cohesion_territorial<=3.9, 1, 2))

data %>% dplyr::select(cohesion_territorial) %>% dfSummary(, graph.col = FALSE)
```


```{r}
## Crear nueva base que contiene el promedio general de cada subdimensión
cohesion <- data %>% dplyr::select(conf_interpersonal, diversidad, lazos, identificacion, justicia, conf_institucional, solidaridad, participacion, cohesion_territorial) %>% na.omit()

cohesion %>% dfSummary(, graph.col = FALSE)
```


# Analisis de clases latentes

## Explorar patrones de respuesta
```{r}
patterns=table(apply(cohesion, 1, paste, collapse=""))
patterns
patterns_m=as.data.frame(patterns)
patterns_m <- patterns_m[order(-patterns_m$Freq),] 
patterns_m
```

## Estimar modelo
```{r}
f <- cbind(conf_interpersonal, diversidad, lazos, identificacion, justicia, conf_institucional, solidaridad, participacion, cohesion_territorial)~1

set.seed(1234)
  
lca3 <- poLCA(f,cohesion, nclass=3,graphs=F)
poLCA.entropy(lca3)
  
  ## Entropía relativa (4 clases)
##Numerator:
nume.E <- -sum(lca3$posterior * log(lca3$posterior))
##Denominator (n*log(K)): ## n is a sample size, and K is a number of class
deno.E <- 1490*log(4)
##Relative Entropy
Entro <- 1-(nume.E/deno.E)
Entro
```

##  Estadísticos de ajuste
```{r}
AIC <-as.numeric(lca3$aic)
BIC <-as.numeric(lca3$bic)
llik <-as.numeric(lca3$llik)
chisq <- as.numeric(lca3$Chisq)
G <- as.numeric(lca3$Gsq)
n.obs <- as.numeric(lca3$Nobs)
Modelos <- c("3 clases")
  
  #CREACIÓN TABLA ESTADÍSTICOS DE AJUSTE MODELOS TODAS LAS VARIABLES
fit.indices <- data.frame(Modelos,AIC,BIC,llik,chisq,G,n.obs)
fit.indices
```

## Ordenar las clases
```{r}
  #Extraer valores de inicio (modelo seleccionado)
probs.start<-lca3$probs.start
  #lca5$probs.start

  #Reanalizar con gráficos
lca3<-poLCA(f, cohesion, nclass=3, probs.start=probs.start,graphs=TRUE, na.rm=TRUE, maxiter=3000)
  
  #Reordnar clases, si es necesario
  #new.probs.start<-poLCA.reorder(probs.start, c(2,1,3,4))
  
  #Re-estimar para nuevo orden
  #lca4<-poLCA(f, elsoc, nclass=4, probs.start=new.probs.start, graphs=TRUE, na.rm=TRUE)
```

