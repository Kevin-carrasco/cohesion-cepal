---
title: "Indicadores longitudinales"
author: "Kevin Carrasco"
date: "11-09-2021"
output: html_document
---

# Indicadores longitudinales

Este documento genera los distintos indicadores que serán utilizados para medir los cambios en la cohesión social en chile en los años 2016-2020. Para esto se utilizan los datos de las cinco olas disponibles de ELSOC.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=F, message=F)
```

```{r include=FALSE}
# Cargar paquetes
pacman::p_load(dplyr, panelr, survey, ggplot2, summarytools)
```

```{r include=FALSE}
# Cargar base elsoc longitudinal (2016-2019) creada en "preparacion"
load("input/data/data.RData")
```

# Relaciones sociales de igualdad

## Lazos
```{r}
data$lazos_w01 = as.numeric(data$vol.red_w01)
data$lazos_w03 = as.numeric(data$vol.red_w03)
data$lazos_w05 = as.numeric(data$vol.red_w05)

data %>% select(lazos_w01, lazos_w03, lazos_w05)  %>% sjlabelled::as_label(.)  %>%  dfSummary(, graph.col = FALSE)
```

## Confianza interpersonal (w01, w02, w03, w04 & w05)
```{r}
data <- data %>%
  rowwise() %>%
  mutate(conf_interpersonal_w01 =
           mean(c(c02_rec_w01, c03_rec_w01), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(conf_interpersonal_w02 =
           mean(c(c02_rec_w02, c03_rec_w02), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(conf_interpersonal_w03 =
           mean(c(c02_rec_w03, c03_rec_w03), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(conf_interpersonal_w04 =
           mean(c(c02_rec_w04, c03_rec_w04), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(conf_interpersonal_w05 =
           mean(c(c02_rec_w05, c03_rec_w05), na.rm = T))

data %>% select(conf_interpersonal_w01, conf_interpersonal_w02, conf_interpersonal_w03, conf_interpersonal_w04, conf_interpersonal_w05)  %>% sjlabelled::as_label(.)  %>%  dfSummary(, graph.col = FALSE)
```

## Reconocimiento y respeto de la diversidad (w01, w02, w03, w04 & w05)

```{r}
data <- data %>%
  rowwise() %>%
  mutate(diversidad_w01 =
           mean(c(c06_04_w01, c06_05_w01, c06_06_w01), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(diversidad_w03 =
           mean(c(c06_04_w03, c06_05_w03, c06_06_w03), na.rm = T))

data %>% select(diversidad_w01, diversidad_w03)  %>% sjlabelled::as_label(.)  %>%  summarytools::dfSummary(, graph.col = FALSE)
```

# Sentido de pertenencia
## Identificación con el país
```{r}
data <- data %>%
  rowwise() %>%
  mutate(identificacion_w01 =
           mean(c(c32_01_w01, c32_02_w01), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(identificacion_w02 =
           mean(c(c32_01_w02, c32_02_w02), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(identificacion_w03 =
           mean(c(c32_01_w03, c32_02_w03), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(identificacion_w04 =
           mean(c(c32_01_w04, c32_02_w04), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(identificacion_w05 =
           mean(c(c32_01_w05, c32_02_w05), na.rm = T))

data %>% select(identificacion_w01, identificacion_w02, identificacion_w03, identificacion_w04, identificacion_w05)  %>% sjlabelled::as_label(.)  %>%  dfSummary(, graph.col = FALSE)
```

## Percepción de justicia
```{r}
data <- data %>%
  rowwise() %>%
  mutate(justicia_w01 =
           mean(c(c18_09_w01, c18_10_w01), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(justicia_w02 =
           mean(c(c18_09_w02, c18_10_w02), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(justicia_w03 =
           mean(c(c18_09_w03, c18_10_w03), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(justicia_w04 =
           mean(c(c18_09_w04, c18_10_w04), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(justicia_w05 =
           mean(c(c18_09_w05, c18_10_w05), na.rm = T))

data %>% select(justicia_w01, justicia_w02, justicia_w03, justicia_w04, justicia_w05)  %>% sjlabelled::as_label(.)  %>%  dfSummary(, graph.col = FALSE)
```

## Confianza institucional
```{r}
data <- data %>%
  rowwise() %>%
  mutate(conf_institucional_w01 =
           mean(c(c05_01_w01, c05_08_w01, c05_02_w01), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(conf_institucional_w02 =
           mean(c(c05_01_w02, c05_08_w02, c05_02_w02), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(conf_institucional_w03 =
           mean(c(c05_01_w03, c05_08_w03, c05_02_w03), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(conf_institucional_w04 =
           mean(c(c05_01_w04, c05_08_w04, c05_02_w04), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(conf_institucional_w05 =
           mean(c(c05_01_w05, c05_08_w05, c05_02_w05), na.rm = T))

data %>% select(conf_institucional_w01, conf_institucional_w02, conf_institucional_w03, conf_institucional_w04, conf_institucional_w05)  %>% sjlabelled::as_label(.)  %>%  dfSummary(, graph.col = FALSE)
```

# Orientación hacia el bien comun
## solidaridad
```{r}
data <- data %>%
  rowwise() %>%
  mutate(solidaridad_w01 =
           mean(c(c07_05_w01, c07_06_w01, c07_07_w01, c07_08_w01), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(solidaridad_w02 =
           mean(c(c07_05_w02, c07_06_w02, c07_07_w02, c07_08_w02), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(solidaridad_w03 =
           mean(c(c07_05_w03, c07_06_w03, c07_07_w03, c07_08_w03), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(solidaridad_w04 =
           mean(c(c07_05_w04, c07_06_w04, c07_07_w04, c07_08_w04), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(solidaridad_w05 =
           mean(c(c07_05_w05, c07_06_w05, c07_07_w05, c07_08_w05), na.rm = T))

data %>% select(solidaridad_w01, solidaridad_w02, solidaridad_w03, solidaridad_w04, solidaridad_w05)  %>% sjlabelled::as_label(.)  %>%  dfSummary(, graph.col = FALSE)
```

## Participación cívica
```{r}
data <- data %>%
  rowwise() %>%
  mutate(participacion_w01 =
           mean(c(c08_01_w01, c08_02_w01, c08_03_w01, c08_04_w01), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(participacion_w02 =
           mean(c(c08_01_w02, c08_02_w02, c08_03_w02, c08_04_w02), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(participacion_w03 =
           mean(c(c08_01_w03, c08_02_w03, c08_03_w03, c08_04_w03), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(participacion_w04 =
           mean(c(c08_01_w04, c08_02_w04, c08_03_w04, c08_04_w04), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(participacion_w05 =
           mean(c(c08_02_w05, c08_04_w05), na.rm = T))

data %>% select(participacion_w01, participacion_w02, participacion_w03, participacion_w04, participacion_w05)  %>% sjlabelled::as_label(.)  %>%  dfSummary(, graph.col = FALSE)
```

# Cohesión territorial
```{r}
data <- data %>%
  rowwise() %>%
  mutate(cohesion_territorial_w01 =
           mean(c(t02_01_w01, t02_02_w01, t02_03_w01, t02_04_w01), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(cohesion_territorial_w02 =
           mean(c(t02_01_w02, t02_02_w02, t02_03_w02, t02_04_w02), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(cohesion_territorial_w03 =
           mean(c(t02_01_w03, t02_02_w03, t02_03_w03, t02_04_w03), na.rm = T))
data <- data %>%
  rowwise() %>%
  mutate(cohesion_territorial_w04 =
           mean(c(t02_01_w04, t02_02_w04, t02_03_w04, t02_04_w04), na.rm = T))

data %>% select(cohesion_territorial_w01, cohesion_territorial_w02, cohesion_territorial_w03, cohesion_territorial_w04)  %>% sjlabelled::as_label(.)  %>%  dfSummary(, graph.col = FALSE)
```

# Reescalar variables

Al crear promedios simples entre las distintas variables aumenta la cantidad de valores de respuesta. Por lo tanto, las variables son reescaladas a sus valores originales, por ejemplo, la variable *diversidad* posee las siguientes categorías de respuesta:
```{r}
sjmisc::frq(data$diversidad_w01)
```

Para una mejor visualización de los datos, las categorías de respuesta son aproximadas a su valor entero más cercano:

* [1, 1.5[ = 1

* [1.5, 2.5[ = 2

* [2.5, 3.5[ = 3

* [3.5, 4.5[ = 4

* [4.5, 5] = 5

```{r}
data$diversidad_w01 <- ifelse((data$diversidad_w01<1.5), 1,
                              ifelse((data$diversidad_w01<2.5), 2,
                                     ifelse((data$diversidad_w01<3.5), 3,
                                            ifelse((data$diversidad_w01<4.5), 4,
                                                   ifelse((data$diversidad_w01<=5), 5, NA)))))
data$diversidad_w03 <- ifelse((data$diversidad_w03<1.5), 1,
                              ifelse((data$diversidad_w03<2.5), 2,
                                     ifelse((data$diversidad_w03<3.5), 3,
                                            ifelse((data$diversidad_w03<4.5), 4,
                                                   ifelse((data$diversidad_w03<=5), 5, NA)))))
                                     
data$diversidad_w01<- factor(data$diversidad_w01, levels = c(1, 2, 3, 4, 5), labels = c("Nada", "Poca", "Algo", "Bastante", "Mucha"))   
data$diversidad_w03<- factor(data$diversidad_w03, levels = c(1, 2, 3, 4, 5), labels = c("Nada", "Poca", "Algo", "Bastante", "Mucha")) 
```

Como resultado, quedan así:
```{r}
data %>% select(diversidad_w01, diversidad_w03)  %>% sjlabelled::as_label(.)  %>%  summarytools::dfSummary(, graph.col = FALSE)
```

## Lazos
```{r}
data$lazos_w01<- factor(data$lazos_w01, levels = c(1, 2, 3, 4, 5), labels = c("No tiene", "De 1 a 2", "De 3 a 5", "De 6 a 10", "Mas de 10"))
data$lazos_w03<- factor(data$lazos_w03, levels = c(1, 2, 3, 4, 5), labels = c("No tiene", "De 1 a 2", "De 3 a 5", "De 6 a 10", "Mas de 10"))
data$lazos_w05<- factor(data$lazos_w05, levels = c(1, 2, 3, 4, 5), labels = c("No tiene", "De 1 a 2", "De 3 a 5", "De 6 a 10", "Mas de 10"))

data %>% select(lazos_w01, lazos_w03, lazos_w05)  %>% sjlabelled::as_label(.)  %>%  dfSummary(, graph.col = FALSE)
```


## Confianza interpersonal

```{r}
data$conf_interpersonal_w01 <- ifelse((data$conf_interpersonal_w01<1.5), 1,
                                        ifelse((data$conf_interpersonal_w01<2.5), 2,
                                               ifelse(data$conf_interpersonal_w01<=3, 3, NA)))
data$conf_interpersonal_w02 <- ifelse((data$conf_interpersonal_w02<1.5), 1,
                                        ifelse((data$conf_interpersonal_w02<2.5), 2,
                                               ifelse(data$conf_interpersonal_w02<=3, 3, NA)))
data$conf_interpersonal_w03 <- ifelse((data$conf_interpersonal_w03<1.5), 1,
                                        ifelse((data$conf_interpersonal_w03<2.5), 2,
                                               ifelse(data$conf_interpersonal_w03<=3, 3, NA)))
data$conf_interpersonal_w04 <- ifelse((data$conf_interpersonal_w04<1.5), 1,
                                        ifelse((data$conf_interpersonal_w04<2.5), 2,
                                               ifelse(data$conf_interpersonal_w04<=3, 3, NA)))
data$conf_interpersonal_w05 <- ifelse((data$conf_interpersonal_w05<1.5), 1,
                                        ifelse((data$conf_interpersonal_w05<2.5), 2,
                                               ifelse(data$conf_interpersonal_w05<=3, 3, NA)))

data$conf_interpersonal_w01<- factor(data$conf_interpersonal_w01, levels = c(1, 2, 3), labels = c("No", "Depende", "Si"))
data$conf_interpersonal_w02<- factor(data$conf_interpersonal_w02, levels = c(1, 2, 3), labels = c("No", "Depende", "Si"))
data$conf_interpersonal_w03<- factor(data$conf_interpersonal_w03, levels = c(1, 2, 3), labels = c("No", "Depende", "Si"))
data$conf_interpersonal_w04<- factor(data$conf_interpersonal_w04, levels = c(1, 2, 3), labels = c("No", "Depende", "Si"))
data$conf_interpersonal_w05<- factor(data$conf_interpersonal_w05, levels = c(1, 2, 3), labels = c("No", "Depende", "Si"))

data %>% select(conf_interpersonal_w01, conf_interpersonal_w02, conf_interpersonal_w03, conf_interpersonal_w04, conf_interpersonal_w05)  %>% sjlabelled::as_label(.)  %>%  dfSummary(, graph.col = FALSE)
```

## Identificación con el país

```{r}
data$identificacion_w01 <- ifelse((data$identificacion_w01<1.5), 1,
                              ifelse((data$identificacion_w01<2.5), 2,
                                     ifelse((data$identificacion_w01<3.5), 3,
                                            ifelse((data$identificacion_w01<4.5), 4,
                                                   ifelse((data$identificacion_w01<=5), 5, NA)))))
data$identificacion_w02 <- ifelse((data$identificacion_w02<1.5), 1,
                              ifelse((data$identificacion_w02<2.5), 2,
                                     ifelse((data$identificacion_w02<3.5), 3,
                                            ifelse((data$identificacion_w02<4.5), 4,
                                                   ifelse((data$identificacion_w02<=5), 5, NA)))))
data$identificacion_w03 <- ifelse((data$identificacion_w03<1.5), 1,
                              ifelse((data$identificacion_w03<2.5), 2,
                                     ifelse((data$identificacion_w03<3.5), 3,
                                            ifelse((data$identificacion_w03<4.5), 4,
                                                   ifelse((data$identificacion_w03<=5), 5, NA)))))
data$identificacion_w04 <- ifelse((data$identificacion_w04<1.5), 1,
                              ifelse((data$identificacion_w04<2.5), 2,
                                     ifelse((data$identificacion_w04<3.5), 3,
                                            ifelse((data$identificacion_w04<4.5), 4,
                                                   ifelse((data$identificacion_w04<=5), 5, NA)))))
data$identificacion_w05 <- ifelse((data$identificacion_w05<1.5), 1,
                              ifelse((data$identificacion_w05<2.5), 2,
                                     ifelse((data$identificacion_w05<3.5), 3,
                                            ifelse((data$identificacion_w05<4.5), 4,
                                                   ifelse((data$identificacion_w05<=5), 5, NA)))))
                                     
data$identificacion_w01<- factor(data$identificacion_w01, levels = c(1, 2, 3, 4, 5), labels = c("Totalmente en desacuerdo", "En desacuerdo", "Ni de acuerdo ni en desacuerdo", "De acuerdo", "Totalmente de acuerdo"))  
data$identificacion_w02<- factor(data$identificacion_w02, levels = c(1, 2, 3, 4, 5), labels = c("Totalmente en desacuerdo", "En desacuerdo", "Ni de acuerdo ni en desacuerdo", "De acuerdo", "Totalmente de acuerdo")) 
data$identificacion_w03<- factor(data$identificacion_w03, levels = c(1, 2, 3, 4, 5), labels = c("Totalmente en desacuerdo", "En desacuerdo", "Ni de acuerdo ni en desacuerdo", "De acuerdo", "Totalmente de acuerdo")) 
data$identificacion_w04<- factor(data$identificacion_w04, levels = c(1, 2, 3, 4, 5), labels = c("Totalmente en desacuerdo", "En desacuerdo", "Ni de acuerdo ni en desacuerdo", "De acuerdo", "Totalmente de acuerdo"))
data$identificacion_w05<- factor(data$identificacion_w05, levels = c(1, 2, 3, 4, 5), labels = c("Totalmente en desacuerdo", "En desacuerdo", "Ni de acuerdo ni en desacuerdo", "De acuerdo", "Totalmente de acuerdo")) 

data %>% select(identificacion_w01, identificacion_w02, identificacion_w03, identificacion_w04, identificacion_w05)  %>% sjlabelled::as_label(.)  %>%  dfSummary(, graph.col = FALSE)
```

## justicia

```{r}
data$justicia_w01 <- ifelse((data$justicia_w01<1.5), 1,
                              ifelse((data$justicia_w01<2.5), 2,
                                     ifelse((data$justicia_w01<3.5), 3,
                                            ifelse((data$justicia_w01<4.5), 4,
                                                   ifelse((data$justicia_w01<=5), 5, NA)))))
data$justicia_w02 <- ifelse((data$justicia_w02<1.5), 1,
                              ifelse((data$justicia_w02<2.5), 2,
                                     ifelse((data$justicia_w02<3.5), 3,
                                            ifelse((data$justicia_w02<4.5), 4,
                                                   ifelse((data$justicia_w02<=5), 5, NA)))))
data$justicia_w03 <- ifelse((data$justicia_w03<1.5), 1,
                              ifelse((data$justicia_w03<2.5), 2,
                                     ifelse((data$justicia_w03<3.5), 3,
                                            ifelse((data$justicia_w03<4.5), 4,
                                                   ifelse((data$justicia_w03<=5), 5, NA)))))
data$justicia_w04 <- ifelse((data$justicia_w04<1.5), 1,
                              ifelse((data$justicia_w04<2.5), 2,
                                     ifelse((data$justicia_w04<3.5), 3,
                                            ifelse((data$justicia_w04<4.5), 4,
                                                   ifelse((data$justicia_w04<=5), 5, NA)))))
data$justicia_w05 <- ifelse((data$justicia_w05<1.5), 1,
                              ifelse((data$justicia_w05<2.5), 2,
                                     ifelse((data$justicia_w05<3.5), 3,
                                            ifelse((data$justicia_w05<4.5), 4,
                                                   ifelse((data$justicia_w05<=5), 5, NA)))))
                                     
data$justicia_w01<- factor(data$justicia_w01, levels = c(1, 2, 3, 4, 5), labels = c("Totalmente en desacuerdo", "En desacuerdo", "Ni de acuerdo ni en desacuerdo", "De acuerdo", "Totalmente de acuerdo"))  
data$justicia_w02<- factor(data$justicia_w02, levels = c(1, 2, 3, 4, 5), labels = c("Totalmente en desacuerdo", "En desacuerdo", "Ni de acuerdo ni en desacuerdo", "De acuerdo", "Totalmente de acuerdo")) 
data$justicia_w03<- factor(data$justicia_w03, levels = c(1, 2, 3, 4, 5), labels = c("Totalmente en desacuerdo", "En desacuerdo", "Ni de acuerdo ni en desacuerdo", "De acuerdo", "Totalmente de acuerdo")) 
data$justicia_w04<- factor(data$justicia_w04, levels = c(1, 2, 3, 4, 5), labels = c("Totalmente en desacuerdo", "En desacuerdo", "Ni de acuerdo ni en desacuerdo", "De acuerdo", "Totalmente de acuerdo"))
data$justicia_w05<- factor(data$justicia_w05, levels = c(1, 2, 3, 4, 5), labels = c("Totalmente en desacuerdo", "En desacuerdo", "Ni de acuerdo ni en desacuerdo", "De acuerdo", "Totalmente de acuerdo")) 

data %>% select(justicia_w01, justicia_w02, justicia_w03, justicia_w04, justicia_w05)  %>% sjlabelled::as_label(.)  %>%  dfSummary(, graph.col = FALSE)
```

## Confianza institucional

```{r}
data$conf_institucional_w01 <- ifelse((data$conf_institucional_w01<1.5), 1,
                              ifelse((data$conf_institucional_w01<2.5), 2,
                                     ifelse((data$conf_institucional_w01<3.5), 3,
                                            ifelse((data$conf_institucional_w01<4.5), 4,
                                                   ifelse((data$conf_institucional_w01<=5), 5, NA)))))
data$conf_institucional_w02 <- ifelse((data$conf_institucional_w02<1.5), 1,
                              ifelse((data$conf_institucional_w02<2.5), 2,
                                     ifelse((data$conf_institucional_w02<3.5), 3,
                                            ifelse((data$conf_institucional_w02<4.5), 4,
                                                   ifelse((data$conf_institucional_w02<=5), 5, NA)))))
data$conf_institucional_w03 <- ifelse((data$conf_institucional_w03<1.5), 1,
                              ifelse((data$conf_institucional_w03<2.5), 2,
                                     ifelse((data$conf_institucional_w03<3.5), 3,
                                            ifelse((data$conf_institucional_w03<4.5), 4,
                                                   ifelse((data$conf_institucional_w03<=5), 5, NA)))))
data$conf_institucional_w04 <- ifelse((data$conf_institucional_w04<1.5), 1,
                              ifelse((data$conf_institucional_w04<2.5), 2,
                                     ifelse((data$conf_institucional_w04<3.5), 3,
                                            ifelse((data$conf_institucional_w04<4.5), 4,
                                                   ifelse((data$conf_institucional_w04<=5), 5, NA)))))
data$conf_institucional_w05 <- ifelse((data$conf_institucional_w05<1.5), 1,
                              ifelse((data$conf_institucional_w05<2.5), 2,
                                     ifelse((data$conf_institucional_w05<3.5), 3,
                                            ifelse((data$conf_institucional_w05<4.5), 4,
                                                   ifelse((data$conf_institucional_w05<=5), 5, NA)))))
                                     
data$conf_institucional_w01<- factor(data$conf_institucional_w01, levels = c(1, 2, 3, 4, 5), labels = c("Nada", "Poco", "Algo", "Bastante", "Mucha"))  
data$conf_institucional_w02<- factor(data$conf_institucional_w02, levels = c(1, 2, 3, 4, 5), labels = c("Nada", "Poco", "Algo", "Bastante", "Mucha")) 
data$conf_institucional_w03<- factor(data$conf_institucional_w03, levels = c(1, 2, 3, 4, 5), labels = c("Nada", "Poco", "Algo", "Bastante", "Mucha")) 
data$conf_institucional_w04<- factor(data$conf_institucional_w04, levels = c(1, 2, 3, 4, 5), labels = c("Nada", "Poco", "Algo", "Bastante", "Mucha"))
data$conf_institucional_w05<- factor(data$conf_institucional_w05, levels = c(1, 2, 3, 4, 5), labels = c("Nada", "Poco", "Algo", "Bastante", "Mucha")) 

data %>% select(conf_institucional_w01, conf_institucional_w02, conf_institucional_w03, conf_institucional_w04, conf_institucional_w05)  %>% sjlabelled::as_label(.)  %>%  dfSummary(, graph.col = FALSE)
```

## Solidaridad

```{r}
data$solidaridad_w01 <- ifelse((data$solidaridad_w01<=1.5), 1,
                                        ifelse((data$solidaridad_w01<2.5), 2,
                                               ifelse(data$solidaridad_w01<=3, 3, NA)))
data$solidaridad_w02 <- ifelse((data$solidaridad_w02<=1.5), 1,
                                        ifelse((data$solidaridad_w02<2.5), 2,
                                               ifelse(data$solidaridad_w02<=3, 3, NA)))
data$solidaridad_w03 <- ifelse((data$solidaridad_w03<=1.5), 1,
                                        ifelse((data$solidaridad_w03<2.5), 2,
                                               ifelse(data$solidaridad_w03<=3, 3, NA)))
data$solidaridad_w04 <- ifelse((data$solidaridad_w04<=1.5), 1,
                                        ifelse((data$solidaridad_w04<2.5), 2,
                                               ifelse(data$solidaridad_w04<=3, 3, NA)))
data$solidaridad_w05 <- ifelse((data$solidaridad_w05<=1.5), 1,
                                        ifelse((data$solidaridad_w05<2.5), 2,
                                               ifelse(data$solidaridad_w05<=3, 3, NA)))

data$solidaridad_w01<- factor(data$solidaridad_w01, levels = c(1, 2, 3), labels = c("Nunca lo hizo", "Lo hizo una o dos veces", "Lo hizo mas de dos veces"))
data$solidaridad_w02<- factor(data$solidaridad_w02, levels = c(1, 2, 3), labels = c("Nunca lo hizo", "Lo hizo una o dos veces", "Lo hizo mas de dos veces"))
data$solidaridad_w03<- factor(data$solidaridad_w03, levels = c(1, 2, 3), labels = c("Nunca lo hizo", "Lo hizo una o dos veces", "Lo hizo mas de dos veces"))
data$solidaridad_w04<- factor(data$solidaridad_w04, levels = c(1, 2, 3), labels = c("Nunca lo hizo", "Lo hizo una o dos veces", "Lo hizo mas de dos veces"))
data$solidaridad_w05<- factor(data$solidaridad_w05, levels = c(1, 2, 3), labels = c("Nunca lo hizo", "Lo hizo una o dos veces", "Lo hizo mas de dos veces"))

data %>% select(solidaridad_w01, solidaridad_w02, solidaridad_w03, solidaridad_w04, solidaridad_w05)  %>% sjlabelled::as_label(.)  %>%  dfSummary(, graph.col = FALSE)
```

## Participación

```{r}
data$participacion_w01 <- ifelse((data$participacion_w01<1.5), 1,
                              ifelse((data$participacion_w01<2.5), 2,
                                     ifelse((data$participacion_w01<3.5), 3,
                                            ifelse((data$participacion_w01<4.5), 4,
                                                   ifelse((data$participacion_w01<=5), 5, NA)))))
data$participacion_w02 <- ifelse((data$participacion_w02<1.5), 1,
                              ifelse((data$participacion_w02<2.5), 2,
                                     ifelse((data$participacion_w02<3.5), 3,
                                            ifelse((data$participacion_w02<4.5), 4,
                                                   ifelse((data$participacion_w02<=5), 5, NA)))))
data$participacion_w03 <- ifelse((data$participacion_w03<1.5), 1,
                              ifelse((data$participacion_w03<2.5), 2,
                                     ifelse((data$participacion_w03<3.5), 3,
                                            ifelse((data$participacion_w03<4.5), 4,
                                                   ifelse((data$participacion_w03<=5), 5, NA)))))
data$participacion_w04 <- ifelse((data$participacion_w04<1.5), 1,
                              ifelse((data$participacion_w04<2.5), 2,
                                     ifelse((data$participacion_w04<3.5), 3,
                                            ifelse((data$participacion_w04<4.5), 4,
                                                   ifelse((data$participacion_w04<=5), 5, NA)))))
                                     
data$participacion_w01<- factor(data$participacion_w01, levels = c(1, 2, 3, 4, 5), labels = c("Nunca", "Casi nunca", "A veces", "Frecuentemente", "Muy frecuentemente"))  
data$participacion_w02<- factor(data$participacion_w02, levels = c(1, 2, 3, 4, 5), labels = c("Nunca", "Casi nunca", "A veces", "Frecuentemente", "Muy frecuentemente")) 
data$participacion_w03<- factor(data$participacion_w03, levels = c(1, 2, 3, 4, 5), labels = c("Nunca", "Casi nunca", "A veces", "Frecuentemente", "Muy frecuentemente")) 
data$participacion_w04<- factor(data$participacion_w04, levels = c(1, 2, 3, 4, 5), labels = c("Nunca", "Casi nunca", "A veces", "Frecuentemente", "Muy frecuentemente"))

data %>% select(participacion_w01, participacion_w02, participacion_w03, participacion_w04, participacion_w05)  %>% sjlabelled::as_label(.)  %>%  dfSummary(, graph.col = FALSE)
```

## Cohesion territorial
```{r}
data$cohesion_territorial_w01 <- ifelse((data$cohesion_territorial_w01<1.5), 1,
                              ifelse((data$cohesion_territorial_w01<2.5), 2,
                                     ifelse((data$cohesion_territorial_w01<3.5), 3,
                                            ifelse((data$cohesion_territorial_w01<4.5), 4,
                                                   ifelse((data$cohesion_territorial_w01<=5), 5, NA)))))
data$cohesion_territorial_w02 <- ifelse((data$cohesion_territorial_w02<1.5), 1,
                              ifelse((data$cohesion_territorial_w02<2.5), 2,
                                     ifelse((data$cohesion_territorial_w02<3.5), 3,
                                            ifelse((data$cohesion_territorial_w02<4.5), 4,
                                                   ifelse((data$cohesion_territorial_w02<=5), 5, NA)))))
data$cohesion_territorial_w03 <- ifelse((data$cohesion_territorial_w03<1.5), 1,
                              ifelse((data$cohesion_territorial_w03<2.5), 2,
                                     ifelse((data$cohesion_territorial_w03<3.5), 3,
                                            ifelse((data$cohesion_territorial_w03<4.5), 4,
                                                   ifelse((data$cohesion_territorial_w03<=5), 5, NA)))))
data$cohesion_territorial_w04 <- ifelse((data$cohesion_territorial_w04<1.5), 1,
                              ifelse((data$cohesion_territorial_w04<2.5), 2,
                                     ifelse((data$cohesion_territorial_w04<3.5), 3,
                                            ifelse((data$cohesion_territorial_w04<4.5), 4,
                                                   ifelse((data$cohesion_territorial_w04<=5), 5, NA)))))
                                     
data$cohesion_territorial_w01<- factor(data$cohesion_territorial_w01, levels = c(1, 2, 3, 4, 5), labels = c("Totalmente en desacuerdo", "En desacuerdo", "Ni de acuerdo ni en desacuerdo", "De acuerdo", "Totalmente de acuerdo"))  
data$cohesion_territorial_w02<- factor(data$cohesion_territorial_w02, levels = c(1, 2, 3, 4, 5), labels = c("Totalmente en desacuerdo", "En desacuerdo", "Ni de acuerdo ni en desacuerdo", "De acuerdo", "Totalmente de acuerdo")) 
data$cohesion_territorial_w03<- factor(data$cohesion_territorial_w03, levels = c(1, 2, 3, 4, 5), labels = c("Totalmente en desacuerdo", "En desacuerdo", "Ni de acuerdo ni en desacuerdo", "De acuerdo", "Totalmente de acuerdo")) 
data$cohesion_territorial_w04<- factor(data$cohesion_territorial_w04, levels = c(1, 2, 3, 4, 5), labels = c("Totalmente en desacuerdo", "En desacuerdo", "Ni de acuerdo ni en desacuerdo", "De acuerdo", "Totalmente de acuerdo"))

data %>% select(cohesion_territorial_w01, cohesion_territorial_w02, cohesion_territorial_w03, cohesion_territorial_w04)  %>% sjlabelled::as_label(.)  %>%  dfSummary(, graph.col = FALSE)
```

# Visualización de datos

```{r}
data$ponderador02_w05 <- data$ponderador02

elsoc_long <- long_panel(data = data, #base de datos formato wide
                         prefix = "_w0", #caracteres antes de la etiqueta de cada ola
                         begin = 1, #etiqueta de la primera ola
                         end = 5, #etiqueta de la última ola
                         label_location = "end", #indica donde se localiza la etiqueta asociada a la ola 
                         id = "idencuesta", #indica identificador individual
                         wave = "ola") #nombre que tomará la variable que indica periodo. 
```

```{r}
#Recode variable "ola" correspondiente a la ola de medición.
elsoc_long$ola <- factor(elsoc_long$ola,labels = c('2016', '2017', '2018', '2019', '2020'))
elsoc_long$ola <- sjlabelled::set_label(elsoc_long$ola, label = c("Ola de Medición"))
                  #etiquetamos variable
```

```{r diseno, echo=TRUE}
elsoc_diseno <- svydesign(ids = ~segmento, #muestreo por conglomerado a nivel de manzanas (segmento)
                          strata = ~estrato, #muestreo estratificado a nivel ciudad (estato)
                          weights = ~ponderador02, #ponderador de corte transversal
                          nest = TRUE,
                          data = elsoc_long)
```

## Lazos

```{r}
#Paso 1
datos.lazos <- data.frame((svytable(~lazos + ola + idencuesta, elsoc_diseno, round = F))) %>% dplyr::filter(Freq>0)  %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit()

#Paso 2
etiquetas.lazos <- data.frame((svytable(~lazos + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit() %>% 
  mutate(idencuesta = 1)
```

```{r}
alluvial_lazos <- ggplot(datos.lazos, aes(x = ola, fill = lazos, stratum = lazos,
                             alluvium = idencuesta, y = porcentaje))+
    ggalluvial::geom_flow(alpha = .66) + 
    ggalluvial::geom_stratum(linetype = 0) +
    scale_y_continuous(labels = scales::percent) + 
    ylab(label = NULL) +
    xlab(label = NULL) + 
    theme(legend.position = 'top',
          legend.title = element_blank()) +
    scale_fill_viridis_d(begin = 0, end = .95, direction = -1, option = 'viridis') +
    geom_text(data = etiquetas.lazos, 
              aes(label = ifelse(porcentaje > 0.03 , scales::percent(porcentaje, accuracy = .1),"")),
              position = position_stack(vjust = .5),
              show.legend = FALSE,
              size = 2,
              color = rep('white'))+
  ggtitle('Cambio de frecuencias según año')

alluvial_lazos

ggsave(alluvial_lazos, file = "bookdown-files/output/graphs/alluvial_lazos.png",device = "png",width = 25,height = 13,dpi = "retina",units = "cm")
```

## Confianza interpersonal
```{r}
#Paso 1
datos.conf.interpersonal <- data.frame((svytable(~conf_interpersonal + ola + idencuesta, elsoc_diseno, round = F))) %>% dplyr::filter(Freq>0)  %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit()

#Paso 2
etiquetas.conf.interpersonal <- data.frame((svytable(~conf_interpersonal + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit() %>% 
  mutate(idencuesta = 1)
```

```{r}
alluvial_conf.interpersonal <- ggplot(datos.conf.interpersonal, 
                                      aes(x = ola, fill = conf_interpersonal, 
                                          stratum = conf_interpersonal,
                                          alluvium = idencuesta, y = porcentaje))+
    ggalluvial::geom_flow(alpha = .66) + 
    ggalluvial::geom_stratum(linetype = 0) +
    scale_y_continuous(labels = scales::percent) + 
    ylab(label = NULL) +
    xlab(label = NULL) + 
    theme(legend.position = 'top',
          legend.title = element_blank()) +
    scale_fill_viridis_d(begin = 0, end = .95, direction = -1, option = 'viridis') +
    geom_text(data = etiquetas.conf.interpersonal, 
              aes(label = ifelse(porcentaje > 0.03 , scales::percent(porcentaje, accuracy = .1),"")),
              position = position_stack(vjust = .5),
              show.legend = FALSE,
              size = 2,
              color = rep('white'))+
  ggtitle('Cambio de frecuencias según año')

alluvial_conf.interpersonal

ggsave(alluvial_conf.interpersonal, file = "bookdown-files/output/graphs/alluvial_conf_interpersonal.png",device = "png",width = 25,height = 13,dpi = "retina",units = "cm")
```

## Diversidad

```{r}
#Paso 1
datos.diversidad <- data.frame((svytable(~diversidad + ola + idencuesta, elsoc_diseno, round = F))) %>% dplyr::filter(Freq>0)  %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit()

#Paso 2
etiquetas.diversidad <- data.frame((svytable(~diversidad + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit() %>% 
  mutate(idencuesta = 1)
```

```{r}
alluvial_diversidad <- ggplot(datos.diversidad, aes(x = ola, fill = diversidad, stratum = diversidad,
                             alluvium = idencuesta, y = porcentaje))+
    ggalluvial::geom_flow(alpha = .66) + 
    ggalluvial::geom_stratum(linetype = 0) +
    scale_y_continuous(labels = scales::percent) + 
    ylab(label = NULL) +
    xlab(label = NULL) + 
    theme(legend.position = 'top',
          legend.title = element_blank()) +
    scale_fill_viridis_d(begin = 0, end = .95, direction = -1, option = 'viridis') +
    geom_text(data = etiquetas.diversidad, 
              aes(label = ifelse(porcentaje > 0.03 , scales::percent(porcentaje, accuracy = .1),"")),
              position = position_stack(vjust = .5),
              show.legend = FALSE,
              size = 2,
              color = rep('white'))+
  ggtitle('Cambio de frecuencias según año')

alluvial_diversidad

ggsave(alluvial_diversidad, file = "bookdown-files/output/graphs/alluvial_diversidad.png",device = "png",width = 25,height = 13,dpi = "retina",units = "cm")
```

## Identificación con el país
```{r}
#Paso 1
datos.identificacion <- data.frame((svytable(~identificacion + ola + idencuesta, elsoc_diseno, round = F))) %>% dplyr::filter(Freq>0)  %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit()

#Paso 2
etiquetas.identificacion <- data.frame((svytable(~identificacion + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit() %>% 
  mutate(idencuesta = 1)
```

```{r}
alluvial_identificacion <- ggplot(datos.identificacion, aes(x = ola, fill = identificacion, stratum = identificacion,
                             alluvium = idencuesta, y = porcentaje))+
    ggalluvial::geom_flow(alpha = .66) + 
    ggalluvial::geom_stratum(linetype = 0) +
    scale_y_continuous(labels = scales::percent) + 
    ylab(label = NULL) +
    xlab(label = NULL) + 
    theme(legend.position = 'top',
          legend.title = element_blank()) +
    scale_fill_viridis_d(begin = 0, end = .95, direction = -1, option = 'viridis') +
    geom_text(data = etiquetas.identificacion, 
              aes(label = ifelse(porcentaje > 0.03 , scales::percent(porcentaje, accuracy = .1),"")),
              position = position_stack(vjust = .5),
              show.legend = FALSE,
              size = 2,
              color = rep('white'))+
  ggtitle('Cambio de frecuencias según año')

alluvial_identificacion

ggsave(alluvial_identificacion, file = "bookdown-files/output/graphs/alluvial_identificacion.png",device = "png",width = 25,height = 13,dpi = "retina",units = "cm")
```

## Percepcion de justicia
```{r}
#Paso 1
datos.justicia <- data.frame((svytable(~justicia + ola + idencuesta, elsoc_diseno, round = F))) %>% dplyr::filter(Freq>0)  %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit()

#Paso 2
etiquetas.justicia <- data.frame((svytable(~justicia + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit() %>% 
  mutate(idencuesta = 1)
```

```{r}
alluvial_justicia <- ggplot(datos.justicia, aes(x = ola, fill = justicia, stratum = justicia,
                             alluvium = idencuesta, y = porcentaje))+
    ggalluvial::geom_flow(alpha = .66) + 
    ggalluvial::geom_stratum(linetype = 0) +
    scale_y_continuous(labels = scales::percent) + 
    ylab(label = NULL) +
    xlab(label = NULL) + 
    theme(legend.position = 'top',
          legend.title = element_blank()) +
    scale_fill_viridis_d(begin = 0, end = .95, direction = -1, option = 'viridis') +
    geom_text(data = etiquetas.justicia, 
              aes(label = ifelse(porcentaje > 0.03 , scales::percent(porcentaje, accuracy = .1),"")),
              position = position_stack(vjust = .5),
              show.legend = FALSE,
              size = 2,
              color = rep('white'))+
  ggtitle('Cambio de frecuencias según año')

alluvial_justicia

ggsave(alluvial_justicia, file = "bookdown-files/output/graphs/alluvial_justicia.png",device = "png",width = 25,height = 13,dpi = "retina",units = "cm")
```

## Confianza institucional
```{r}
#Paso 1
datos.conf.institucional <- data.frame((svytable(~conf_institucional + ola + idencuesta, elsoc_diseno, round = F))) %>% dplyr::filter(Freq>0)  %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit()

#Paso 2
etiquetas.conf.institucional <- data.frame((svytable(~conf_institucional + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit() %>% 
  mutate(idencuesta = 1)
```

```{r}
alluvial_conf.institucional <- ggplot(datos.conf.institucional, aes(x = ola, fill = conf_institucional, stratum = conf_institucional,
                             alluvium = idencuesta, y = porcentaje))+
    ggalluvial::geom_flow(alpha = .66) + 
    ggalluvial::geom_stratum(linetype = 0) +
    scale_y_continuous(labels = scales::percent) + 
    ylab(label = NULL) +
    xlab(label = NULL) + 
    theme(legend.position = 'top',
          legend.title = element_blank()) +
    scale_fill_viridis_d(begin = 0, end = .95, direction = -1, option = 'viridis') +
    geom_text(data = etiquetas.conf.institucional, 
              aes(label = ifelse(porcentaje > 0.03 , scales::percent(porcentaje, accuracy = .1),"")),
              position = position_stack(vjust = .5),
              show.legend = FALSE,
              size = 2,
              color = rep('white'))+
  ggtitle('Cambio de frecuencias según año')

alluvial_conf.institucional

ggsave(alluvial_conf.institucional, file = "bookdown-files/output/graphs/alluvial_conf_institucional.png",device = "png",width = 25,height = 13,dpi = "retina",units = "cm")
```

## Solidaridad

```{r}
#Paso 1
datos.solidaridad <- data.frame((svytable(~solidaridad + ola + idencuesta, elsoc_diseno, round = F))) %>% dplyr::filter(Freq>0)  %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit()

#Paso 2
etiquetas.solidaridad <- data.frame((svytable(~solidaridad + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit() %>% 
  mutate(idencuesta = 1)
```

```{r}
alluvial_solidaridad <- ggplot(datos.solidaridad, aes(x = ola, fill = solidaridad, stratum = solidaridad,
                             alluvium = idencuesta, y = porcentaje))+
    ggalluvial::geom_flow(alpha = .66) + 
    ggalluvial::geom_stratum(linetype = 0) +
    scale_y_continuous(labels = scales::percent) + 
    ylab(label = NULL) +
    xlab(label = NULL) + 
    theme(legend.position = 'top',
          legend.title = element_blank()) +
    scale_fill_viridis_d(begin = 0, end = .95, direction = -1, option = 'viridis') +
    geom_text(data = etiquetas.solidaridad, 
              aes(label = ifelse(porcentaje > 0.03 , scales::percent(porcentaje, accuracy = .1),"")),
              position = position_stack(vjust = .5),
              show.legend = FALSE,
              size = 2,
              color = rep('white'))+
  ggtitle('Cambio de frecuencias según año')

alluvial_solidaridad

ggsave(alluvial_solidaridad, file = "bookdown-files/output/graphs/alluvial_solidaridad.png",device = "png",width = 25,height = 13,dpi = "retina",units = "cm")
```

## Participación cívica
```{r}
#Paso 1
datos.participacion <- data.frame((svytable(~participacion + ola + idencuesta, elsoc_diseno, round = F))) %>% dplyr::filter(Freq>0)  %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit()

#Paso 2
etiquetas.participacion <- data.frame((svytable(~participacion + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit() %>% 
  mutate(idencuesta = 1)
```

```{r}
alluvial_participacion <- ggplot(datos.participacion, aes(x = ola, fill = participacion, stratum = participacion,
                             alluvium = idencuesta, y = porcentaje))+
    ggalluvial::geom_flow(alpha = .66) + 
    ggalluvial::geom_stratum(linetype = 0) +
    scale_y_continuous(labels = scales::percent) + 
    ylab(label = NULL) +
    xlab(label = NULL) + 
    theme(legend.position = 'top',
          legend.title = element_blank()) +
    scale_fill_viridis_d(begin = 0, end = .95, direction = -1, option = 'viridis') +
    geom_text(data = etiquetas.participacion, 
              aes(label = ifelse(porcentaje > 0.03 , scales::percent(porcentaje, accuracy = .1),"")),
              position = position_stack(vjust = .5),
              show.legend = FALSE,
              size = 2,
              color = rep('white'))+
  ggtitle('Cambio de frecuencias según año')

alluvial_participacion

ggsave(alluvial_participacion, file = "bookdown-files/output/graphs/alluvial_participacion.png",device = "png",width = 25,height = 13,dpi = "retina",units = "cm")
```

## Cohesion territorial
```{r}
#Paso 1
datos.cohesion_territorial <- data.frame((svytable(~cohesion_territorial + ola + idencuesta, elsoc_diseno, round = F))) %>% dplyr::filter(Freq>0)  %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit()

#Paso 2
etiquetas.cohesion_territorial <- data.frame((svytable(~cohesion_territorial + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit() %>% 
  mutate(idencuesta = 1)
```

```{r}
alluvial_cohesion_territorial <- ggplot(datos.cohesion_territorial, aes(x = ola, fill = cohesion_territorial, stratum = cohesion_territorial,
                             alluvium = idencuesta, y = porcentaje))+
    ggalluvial::geom_flow(alpha = .66) + 
    ggalluvial::geom_stratum(linetype = 0) +
    scale_y_continuous(labels = scales::percent) + 
    ylab(label = NULL) +
    xlab(label = NULL) + 
    theme(legend.position = 'top',
          legend.title = element_blank()) +
    scale_fill_viridis_d(begin = 0, end = .95, direction = -1, option = 'viridis') +
    geom_text(data = etiquetas.cohesion_territorial, 
              aes(label = ifelse(porcentaje > 0.03 , scales::percent(porcentaje, accuracy = .1),"")),
              position = position_stack(vjust = .5),
              show.legend = FALSE,
              size = 2,
              color = rep('white'))+
  ggtitle('Cambio de frecuencias según año')

alluvial_cohesion_territorial

ggsave(alluvial_cohesion_territorial, file = "bookdown-files/output/graphs/alluvial_cohesion_territorial.png",device = "png",width = 25,height = 13,dpi = "retina",units = "cm")
```





